# ê³ ê¸‰ íŒŒì¼ ë°±ì—… ìœ í‹¸ë¦¬í‹° Makefile
# Version 2.0.0

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -g
TARGET = backup
SRCDIR = src
TESTDIR = test

# ê¸°ë³¸ ë¹Œë“œ
$(TARGET): $(SRCDIR)/backup.c
	$(CC) $(CFLAGS) -o $(TARGET) $(SRCDIR)/backup.c
	@echo "âœ… ë¹Œë“œ ì™„ë£Œ: ./$(TARGET)"

# ë””ë²„ê·¸ ë¹Œë“œ
debug: CFLAGS += -DDEBUG -O0
debug: $(TARGET)
	@echo "ğŸ› ë””ë²„ê·¸ ë¹Œë“œ ì™„ë£Œ"

# ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
release: CFLAGS += -DNDEBUG -O3 -s
release: $(TARGET)
	@echo "ğŸš€ ë¦´ë¦¬ì¦ˆ ë¹Œë“œ ì™„ë£Œ"

# ì •ë¦¬
clean:
	rm -f ./$(TARGET)
	rm -f *.log
	rm -rf $(TESTDIR)
	rm -f test*.txt backup*.txt restored*.txt
	rm -f core dump*
	@echo "ğŸ§¹ ì •ë¦¬ ì™„ë£Œ"

# ê¸°ë³¸ í…ŒìŠ¤íŠ¸
test: $(TARGET)
	@echo "ğŸ§ª ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
	@echo
	@echo "=== ë²„ì „ ì •ë³´ ==="
	./$(TARGET) version
	@echo
	@echo "=== ë„ì›€ë§ ==="
	./$(TARGET) help
	@echo
	@echo "=== ë‹¨ì¼ íŒŒì¼ ë°±ì—… í…ŒìŠ¤íŠ¸ ==="
	echo "Hello, World! ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ íŒŒì¼ì…ë‹ˆë‹¤." > test.txt
	echo "ë‘ ë²ˆì§¸ ì¤„ì…ë‹ˆë‹¤." >> test.txt
	echo "ì„¸ ë²ˆì§¸ ì¤„ì…ë‹ˆë‹¤." >> test.txt
	./$(TARGET) backup -v -m -c test.txt backup_test.txt
	@echo
	@echo "=== ë°±ì—…ëœ íŒŒì¼ í™•ì¸ ==="
	cat backup_test.txt
	@echo
	@echo "=== ë³µì› í…ŒìŠ¤íŠ¸ ==="
	rm test.txt
	./$(TARGET) restore -v backup_test.txt restored_test.txt
	@echo
	@echo "=== ë³µì›ëœ íŒŒì¼ í™•ì¸ ==="
	cat restored_test.txt
	@echo
	@echo "âœ… ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ê³ ê¸‰ í…ŒìŠ¤íŠ¸
test-advanced: $(TARGET)
	@echo "ğŸš€ ê³ ê¸‰ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
	@echo
	@echo "=== í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ==="
	mkdir -p $(TESTDIR)/source/subdir1/subdir2
	mkdir -p $(TESTDIR)/backup
	echo "ë©”ì¸ íŒŒì¼ì…ë‹ˆë‹¤." > $(TESTDIR)/source/main.txt
	echo "í•˜ìœ„ ë””ë ‰í† ë¦¬ íŒŒì¼1" > $(TESTDIR)/source/subdir1/file1.txt
	echo "í•˜ìœ„ ë””ë ‰í† ë¦¬ íŒŒì¼2" > $(TESTDIR)/source/subdir1/file2.txt
	echo "ê¹Šì€ í•˜ìœ„ ë””ë ‰í† ë¦¬ íŒŒì¼" > $(TESTDIR)/source/subdir1/subdir2/deep.txt
	@echo
	@echo "=== ì¬ê·€ ë””ë ‰í† ë¦¬ ë°±ì—… í…ŒìŠ¤íŠ¸ ==="
	./$(TARGET) backup -v -r -m -c -l backup.log $(TESTDIR)/source $(TESTDIR)/backup
	@echo
	@echo "=== ë°±ì—… ëª©ë¡ í™•ì¸ ==="
	./$(TARGET) list $(TESTDIR)/backup
	@echo
	@echo "=== ë¡œê·¸ íŒŒì¼ í™•ì¸ ==="
	if [ -f backup.log ]; then echo "ë¡œê·¸ íŒŒì¼ ë§ˆì§€ë§‰ 5ì¤„:"; tail -5 backup.log; fi
	@echo
	@echo "âœ… ê³ ê¸‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
test-performance: $(TARGET)
	@echo "âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
	@echo
	@echo "=== ëŒ€ìš©ëŸ‰ íŒŒì¼ ìƒì„± ==="
	dd if=/dev/zero of=large_test.txt bs=1M count=10 2>/dev/null
	@echo
	@echo "=== ëŒ€ìš©ëŸ‰ íŒŒì¼ ë°±ì—… í…ŒìŠ¤íŠ¸ ==="
	time ./$(TARGET) backup -v -c large_test.txt large_backup.txt
	@echo
	@echo "=== íŒŒì¼ í¬ê¸° í™•ì¸ ==="
	ls -lh large_test.txt large_backup.txt
	@echo
	@echo "âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
test-error: $(TARGET)
	@echo "ğŸ”¥ ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
	@echo
	@echo "=== ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼ ë°±ì—… ì‹œë„ ==="
	./$(TARGET) backup -v nonexistent.txt backup.txt || echo "ì˜ˆìƒëœ ì˜¤ë¥˜ì…ë‹ˆë‹¤."
	@echo
	@echo "=== ê¶Œí•œ ì—†ëŠ” ë””ë ‰í† ë¦¬ ë°±ì—… ì‹œë„ ==="
	./$(TARGET) backup -v /root/. backup/ || echo "ì˜ˆìƒëœ ì˜¤ë¥˜ì…ë‹ˆë‹¤."
	@echo
	@echo "=== ì˜ëª»ëœ ëª…ë ¹ì–´ í…ŒìŠ¤íŠ¸ ==="
	./$(TARGET) invalid_command || echo "ì˜ˆìƒëœ ì˜¤ë¥˜ì…ë‹ˆë‹¤."
	@echo
	@echo "âœ… ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
test-all: test test-advanced test-performance test-error
	@echo
	@echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (cppcheckê°€ ì„¤ì¹˜ëœ ê²½ìš°)
lint:
	@if command -v cppcheck >/dev/null 2>&1; then \
		echo "ğŸ” ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬..."; \
		cppcheck --enable=all --std=c99 $(SRCDIR)/backup.c; \
	else \
		echo "âš ï¸  cppcheckê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; \
	fi

# ì„¤ì¹˜
install: $(TARGET)
	@echo "ğŸ“¦ ì‹œìŠ¤í…œì— ì„¤ì¹˜ ì¤‘..."
	sudo cp $(TARGET) /usr/local/bin/
	sudo chmod +x /usr/local/bin/$(TARGET)
	@echo "âœ… ì„¤ì¹˜ ì™„ë£Œ: /usr/local/bin/$(TARGET)"

# ì œê±°
uninstall:
	@echo "ğŸ—‘ï¸  ì‹œìŠ¤í…œì—ì„œ ì œê±° ì¤‘..."
	sudo rm -f /usr/local/bin/$(TARGET)
	@echo "âœ… ì œê±° ì™„ë£Œ"

# ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
package: clean $(TARGET)
	@echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘..."
	mkdir -p backup-utility-2.0.0
	cp $(TARGET) backup-utility-2.0.0/
	cp Makefile backup-utility-2.0.0/
	cp README.md backup-utility-2.0.0/
	cp -r $(SRCDIR) backup-utility-2.0.0/
	tar -czf backup-utility-2.0.0.tar.gz backup-utility-2.0.0/
	rm -rf backup-utility-2.0.0/
	@echo "âœ… íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ: backup-utility-2.0.0.tar.gz"

# ë„ì›€ë§
help:
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ Make íƒ€ê²Ÿ:"
	@echo "  make          - ê¸°ë³¸ ë¹Œë“œ"
	@echo "  make debug    - ë””ë²„ê·¸ ë¹Œë“œ"
	@echo "  make release  - ë¦´ë¦¬ì¦ˆ ë¹Œë“œ"
	@echo "  make test     - ê¸°ë³¸ í…ŒìŠ¤íŠ¸"
	@echo "  make test-advanced - ê³ ê¸‰ í…ŒìŠ¤íŠ¸"
	@echo "  make test-performance - ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
	@echo "  make test-error - ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸"
	@echo "  make test-all - ëª¨ë“  í…ŒìŠ¤íŠ¸"
	@echo "  make lint     - ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬"
	@echo "  make install  - ì‹œìŠ¤í…œì— ì„¤ì¹˜"
	@echo "  make uninstall - ì‹œìŠ¤í…œì—ì„œ ì œê±°"
	@echo "  make package  - ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±"
	@echo "  make clean    - ì •ë¦¬"
	@echo "  make help     - ì´ ë„ì›€ë§"

.PHONY: debug release clean test test-advanced test-performance test-error test-all lint install uninstall package help
